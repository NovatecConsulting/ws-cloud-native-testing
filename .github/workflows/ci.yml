name: CI Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  pact:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Delete Contracts from Provider
        run: rm ./contract-testing/pact/provider/src/test/pacts/*.json
      - name: Build Consumer One
        run: ./gradlew :contract-testing:pact:consumer-one:build
      - name: Copy Contracts of Consumer One to Provider
        run: cp ./contract-testing/pact/consumer-one/build/pacts/*.json ./contract-testing/pact/provider/src/test/pacts
      - name: Build Consumer Two
        run: ./gradlew :contract-testing:pact:consumer-two:build
      - name: Copy Contracts of Consumer Two to Provider
        run: cp ./contract-testing/pact/consumer-two/build/pacts/*.json ./contract-testing/pact/provider/src/test/pacts
      - name: Build Provider
        run: ./gradlew :contract-testing:pact:provider:build

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_pact
          path: "**/build/reports/tests"

  pact-messaging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Delete Contracts from Provider
        run: rm ./contract-testing/pact-messaging/provider/src/test/pacts/*.json
      - name: Build Consumer
        run: ./gradlew :contract-testing:pact-messaging:consumer:build
      - name: Copy Contracts of Consumer to Provider
        run: cp ./contract-testing/pact-messaging/consumer/build/pacts/*.json ./contract-testing/pact-messaging/provider/src/test/pacts
      - name: Build Provider
        run: ./gradlew :contract-testing:pact-messaging:provider:build

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_pact-messaging
          path: "**/build/reports/tests"

  spring-cloud-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build Provider & Publish Stubs
        run: ./gradlew :contract-testing:spring-cloud-contract:provider:build :contract-testing:spring-cloud-contract:provider:publishToMavenLocal
      - name: Build Consumer One
        run: ./gradlew :contract-testing:spring-cloud-contract:consumer-one:build
      - name: Build Consumer Two
        run: ./gradlew :contract-testing:spring-cloud-contract:consumer-two:build

      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-cloud-contract
          path: "**/build/reports/tests"

  spring-boot_messaging-rabbitmq:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:messaging-rabbitmq:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_messaging-rabbitmq
          path: "**/build/reports/tests"

  spring-boot_messaging-kafka:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:messaging-kafka:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_messaging-kafka
          path: "**/build/reports/tests"

  spring-boot_caching:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:caching:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_caching
          path: "**/build/reports/tests"

  spring-boot_http-clients:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:http-clients:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_http-clients
          path: "**/build/reports/tests"

  spring-boot_jdbc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:jdbc:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_jdbc
          path: "**/build/reports/tests"

  spring-boot_data-jpa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:data-jpa:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_data-jpa
          path: "**/build/reports/tests"

  spring-boot_data-mongodb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:data-mongodb:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_data-mongodb
          path: "**/build/reports/tests"

  spring-boot_security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:security:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_security
          path: "**/build/reports/tests"

  spring-boot_basics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:basics:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_basics
          path: "**/build/reports/tests"

  spring-boot_webmvc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:webmvc:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_webmvc
          path: "**/build/reports/tests"

  spring-boot_webflux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build
        run: ./gradlew :spring-boot:webflux:build
      - name: Upload Test Results
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-results_spring-boot_webflux
          path: "**/build/reports/tests"
